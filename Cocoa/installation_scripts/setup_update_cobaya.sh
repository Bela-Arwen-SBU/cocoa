# --------------------------------------------------------------------------------------
# --------------------------------------------------------------------------------------
# --------------------------------------------------------------------------------------
echo -e '\033[1;44m''Updating Cobaya Package''\033[0m'

if [ -z "${ROOTDIR}" ]; then
    echo -e '\033[0;31m''ERROR ENV VARIABLE ROOTDIR IS NOT DEFINED''\033[0m'
    return 1
fi
if [ -z "${CXX_COMPILER}" ]; then
    echo -e '\033[0;31m''ERROR ENV VARIABLE CXX_COMPILER IS NOT DEFINED''\033[0m'
    cd $ROOTDIR
    return 1
fi
if [ -z "${C_COMPILER}" ]; then
    echo -e '\033[0;31m''ERROR ENV VARIABLE C_COMPILER IS NOT DEFINED''\033[0m'
    cd $ROOTDIR
    return 1
fi
if [ -z "${PIP3}" ]; then
  echo -e '\033[0;31m''ERROR ENV VARIABLE IS NOT DEFINED''\033[0m'
  cd $ROOTDIR
  return 1
fi
if [ -z "${PYTHON3}" ]; then
  echo -e '\033[0;31m''ERROR ENV VARIABLE PIP3 IS NOT DEFINED''\033[0m'
  cd $ROOTDIR
  return 1
fi

if [ -z "${DEBUG_PIP_OUTPUT}" ]; then
  export OUTPUT_UPDATE_COBAYA_1="/dev/null"
  export OUTPUT_UPDATE_COBAYA_2="/dev/null"
  export UPDATE_COBAYA_MAKE_NUM_THREADS="${MAKE_NUM_THREADS}"
else
  export OUTPUT_UPDATE_COBAYA_1="/dev/tty"
  export OUTPUT_UPDATE_COBAYA_2="/dev/tty"
  export PIP_MAKE_NUM_THREADS=1
fi
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
export COBAYA=$ROOTDIR/cobaya/
export COBAYA_COCOA=$ROOTDIR/../cocoa_installation_libraries/cobaya_changes
export CBLIKE=cobaya/likelihoods
export CBTH=cobaya/theories
export HGL=planck_2018_highl_plik
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------

cd $ROOTDIR

#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
# Remove any previous installed cobaya folder
rm -rf $ROOTDIR/cobaya
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
export COBAYA_GIT_COMMIT="2636ea9ed399c35c5d276de1acb15aaafbcab10c"
git clone https://github.com/CobayaSampler/cobaya.git cobaya
cd $COBAYA
git reset --hard $COBAYA_GIT_COMMIT
cd $ROOTDIR
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------

#-------------------------------------------------------------------------------
# Adjust Cobaya Files ----------------------------------------------------------
#-------------------------------------------------------------------------------
cp $COBAYA_COCOA/cobaya/change_python_files.sh $COBAYA/cobaya/
cd $COBAYA/cobaya/
sh change_python_files.sh
cd $ROOTDIR
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------

#-------------------------------------------------------------------------------
# SN / STRONG LENSING ----------------------------------------------------------
#-------------------------------------------------------------------------------
cp $COBAYA_COCOA/$CBLIKE/sn/roman_* $COBAYA/$CBLIKE/sn/
cp -r $COBAYA_COCOA/$CBLIKE/h0licow/ $COBAYA/$CBLIKE/
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------

#-------------------------------------------------------------------------------
# DES-Y1 -----------------------------------------------------------------------
#-------------------------------------------------------------------------------
# WE REMOVE COBAYA NATIVE DES-Y1
rm -rf $COBAYA/$CBLIKE/des_y1
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------

#-------------------------------------------------------------------------------
# 2015 -------------------------------------------------------------------------
#-------------------------------------------------------------------------------
# WE REMOVE PLANCK 2015 DATA
rm -rf $COBAYA/$CBLIKE/planck_2015_*
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------

#-------------------------------------------------------------------------------
# CHANGE PLANCK CLIK -----------------------------------------------------------
#-------------------------------------------------------------------------------
cp -r $COBAYA_COCOA/$CBLIKE/base_classes/change_planck_clik.sh $COBAYA/$CBLIKE/base_classes/
cd $COBAYA/$CBLIKE/base_classes/
sh change_planck_clik.sh
cd $ROOTDIR
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------

#-------------------------------------------------------------------------------
# CAMSPEC ----------------------------------------------------------------------
#-------------------------------------------------------------------------------
# WE REMOVE UNBINNED PLANCK CAMSPEC (TODO IN THE FUTURE: FIX THEIR YAML)
rm -rf $COBAYA/$CBLIKE/planck_2018_highl_CamSpec

cp $COBAYA_COCOA/$CBLIKE/base_classes/InstallableLikelihood.patch $COBAYA/$CBLIKE/base_classes/
cd COBAYA/$CBLIKE/base_classes/
patch -u InstallableLikelihood.py -i InstallableLikelihood.patch
cd $ROOTDIR

#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------

#-------------------------------------------------------------------------------
# LOWELL -----------------------------------------------------------------------
#-------------------------------------------------------------------------------
# WE REMOVE LEWIS NATIVE LIKELIHOOD 
rm -f $COBAYA/$CBLIKE/planck_2018_lowl/EE_clik.py
rm -f $COBAYA/$CBLIKE/planck_2018_lowl/EE_clik.yaml
rm -f $COBAYA/$CBLIKE/planck_2018_lowl/EE_sroll2.py
rm -f $COBAYA/$CBLIKE/planck_2018_lowl/EE_sroll2.bibtex

#WE RENAME TT/EE.py to also mean TT/EE_clik.py
cp $COBAYA_COCOA/$CBLIKE/planck_2018_lowl/EE.py $COBAYA/$CBLIKE/planck_2018_lowl/EE.py
cp $COBAYA_COCOA/$CBLIKE/planck_2018_lowl/EE.yaml $COBAYA/$CBLIKE/planck_2018_lowl/EE.yaml

cp $COBAYA_COCOA/$CBLIKE/planck_2018_lowl/TT.py $COBAYA/$CBLIKE/planck_2018_lowl/TT.py
cp $COBAYA_COCOA/$CBLIKE/planck_2018_lowl/TT.yaml $COBAYA/$CBLIKE/planck_2018_lowl/TT.yaml
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------

#-------------------------------------------------------------------------------
# LENSING ----------------------------------------------------------------------
#-------------------------------------------------------------------------------
# WE REMOVE LEWIS NATIVE LIKELIHOOD
rm -f $COBAYA/$CBLIKE/planck_2018_lensing/CMBMarged.yaml
rm -f $COBAYA/$CBLIKE/planck_2018_lensing/native.yaml

# WE COPY FIXED YAML FILE
cp $COBAYA_COCOA/$CBLIKE/planck_2018_lensing/clik.yaml $COBAYA/$CBLIKE/planck_2018_lensing/clik.yaml
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------

#-------------------------------------------------------------------------------
# HIGHELL_PLIK -----------------------------------------------------------------
#-------------------------------------------------------------------------------
# WE REMOVE UNBINNED
rm -f $COBAYA/$CBLIKE/$HGL/TTTEEE_unbinned.py
rm -f $COBAYA/$CBLIKE/$HGL/TTTEEE_unbinned.yaml
rm -f $COBAYA/$CBLIKE/$HGL/TT_unbinned.py
rm -f $COBAYA/$CBLIKE/$HGL/TT_unbinned.yaml

# REMOVE LEWIS NATIVE REIMPLEMENTATION
rm -f $COBAYA/$CBLIKE/$HGL/TTTEEE_lite_native.py
rm -f $COBAYA/$CBLIKE/$HGL/TTTEEE_lite_native.yaml

rm -f $COBAYA/$CBLIKE/$HGL/TT_lite_native.py
rm -f $COBAYA/$CBLIKE/$HGL/TT_lite_native.yaml

# FIX YAML
cp $COBAYA_COCOA/$CBLIKE/$HGL/EE.yaml $COBAYA/$CBLIKE/$HGL/EE.yaml
cp $COBAYA_COCOA/$CBLIKE/$HGL/TE.yaml $COBAYA/$CBLIKE/$HGL/TE.yaml

cp $COBAYA_COCOA/$CBLIKE/$HGL/TT.yaml $COBAYA/$CBLIKE/$HGL/TT.yaml
cp $COBAYA_COCOA/$CBLIKE/$HGL/TTTEEE.yaml $COBAYA/$CBLIKE/$HGL/TTTEEE.yaml

cp $COBAYA_COCOA/$CBLIKE/$HGL/TT_lite.yaml $COBAYA/$CBLIKE/$HGL/TT_lite.yaml
cp $COBAYA_COCOA/$CBLIKE/$HGL/TTTEEE_lite.yaml $COBAYA/$CBLIKE/$HGL/TTTEEE_lite.yaml
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------

#-------------------------------------------------------------------------------
# SPT3G Y1 -------------------------------------------------------------
#-------------------------------------------------------------------------------
cp -r $COBAYA_COCOA/$CBLIKE/SPT3G_Y1 $COBAYA/$CBLIKE/SPT3G_Y1
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------

#-------------------------------------------------------------------------------
# ACT DR6 LENSLIKE -------------------------------------------------------------
#-------------------------------------------------------------------------------
cp -r $COBAYA_COCOA/$CBLIKE/act_dr6_lenslike $COBAYA/$CBLIKE/act_dr6_lenslike
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------

#-------------------------------------------------------------------------------
# SO ---------------------------------------------------------------------------
#-------------------------------------------------------------------------------
cp -r $COBAYA_COCOA/$CBLIKE/mflike $COBAYA/$CBLIKE/mflike
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------

#-------------------------------------------------------------------------------
# FIX RENAMING IN CAMB ---------------------------------------------------------
#-------------------------------------------------------------------------------
cp $COBAYA_COCOA/$CBTH/camb/camb.yaml $COBAYA/$CBTH/camb/camb.yaml

#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
unset COBAYA
unset COBAYA_COCOA
unset CBLIKE
unset CBTH
unset HGL
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
